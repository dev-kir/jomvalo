<%- include('templates/html_start'); %>
    <%- include('templates/head'); %> 
    <%- include('templates/body_start'); %>
        <%- include('templates/header'); %>

        <div name="main" class="px-4 py-4 sm:px-4 sm:py-4 text-zinc-900 mx-auto font-light text-sm sm:text-base">            
            <div class="flex justify-center items-center py-24">
                <img id="gifImage" class="max-w-52" alt="GIF">
            </div>
            <div>
                <h1>Will u play valorant with me ? ðŸ¥º</h1>
            </div>
            <div class="flex justify-center py-8">
                <button id="sendMessageButton" class="text-slate-700 hover:text-white border border-slate-700 hover:bg-slate-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2">Yes</button>
                <button id="rejectButton" class="text-white bg-red-700 hover:text-white border border-red-700 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2" onclick="refreshPage()">No</button>
            </div>
        </div>

        <!-- Main modal -->
        <div id="authentication-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full h-full bg-black bg-opacity-50">
            <div class="relative p-4 w-full max-w-md max-h-full">
                <div class="relative bg-white rounded-lg shadow">
                    <div class="flex items-center justify-between p-4 border-b rounded-t">
                        <h3 class="text-xl font-semibold text-gray-900">
                            Enter your username
                        </h3>
                    </div>
                    <div class="p-6">
                        <form id="username-form" action="/set-username" method="POST" class="space-y-4">
                            <div>
                                <input type="text" name="username" id="username" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-slate-500 focus:border-slate-500 block w-full p-2.5" placeholder="Your valorant's username" required />
                            </div>
                            <div class="cf-turnstile" data-sitekey="<%= process.env.CLOUDFLARE_TURNSTILE_SITE_KEY %>"></div>
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <button type="submit" class="w-full text-white bg-slate-700 hover:bg-slate-800 focus:ring-4 focus:outline-none focus:ring-slate-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <%- include('templates/footer'); %>
    <%- include('templates/body_end'); %>
    <%- include('templates/script'); %>
    <script>
        document.getElementById("username-form").addEventListener("submit", function(event) {
            const usernameInput = document.getElementById("username");
            const usernameValue = usernameInput.value.trim();

            if (usernameValue === "") {
                // Prevent form submission
                event.preventDefault();
                // Display error message
                const errorMessage = document.getElementById("username-error-message");
                errorMessage.innerText = "Username is required.";
            }
        });

        const invite_gif = [
            "../assets/gif/invite/i-1.gif",
            "../assets/gif/invite/i-2.gif",
            "../assets/gif/invite/i-3.gif",
            "../assets/gif/invite/i-4.gif",
            "../assets/gif/invite/i-5.gif",
            "../assets/gif/invite/i-6.gif",
            "../assets/gif/invite/i-7.gif",
            "../assets/gif/invite/i-8.gif",
            "../assets/gif/invite/i-9.gif",
            "../assets/gif/invite/i-10.gif",
            "../assets/gif/invite/i-11.gif",
            "../assets/gif/invite/i-12.gif",
            "../assets/gif/invite/i-13.gif",
            "../assets/gif/invite/i-14.gif",
        ];

        const accept_gif = [
            "../assets/gif/accept/a-1.gif",
            "../assets/gif/accept/a-2.gif",
            "../assets/gif/accept/a-3.gif",
            "../assets/gif/accept/a-4.gif",
            "../assets/gif/accept/a-5.gif",
            "../assets/gif/accept/a-6.gif",
            "../assets/gif/accept/a-7.gif",
        ];

        document.getElementById("sendMessageButton").addEventListener("click", async () => {
            try {
                const randomIndex = Math.floor(Math.random() * accept_gif.length);
                const randomGif = accept_gif[randomIndex];
                const username = "<%= username %>";
                const message = `${username} just invited you to valorant ðŸ¥´`;

                const location = randomGif;

                const response = await fetch("/tete", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "CSRF-Token": "<%= csrfToken %>"
                    },
                    body: JSON.stringify({ message: message })
                });
            
                if (response.ok) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/letsgo';

                    const locationInput = document.createElement('input');
                    locationInput.type = 'hidden';
                    locationInput.name = 'location';
                    locationInput.value = location;

                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = '_csrf';
                    csrfInput.value = "<%= csrfToken %>";

                    form.appendChild(locationInput);
                    form.appendChild(csrfInput);

                    document.body.appendChild(form);
                    form.submit();
                } else {
                    throw new Error("Failed to send message to Telegram");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });       

        // document.getElementById("rejectButton").addEventListener("mousemove", (event) => {
        //     const button = document.getElementById("rejectButton");
        //     const buttonRect = button.getBoundingClientRect();
        //     const containerRect = button.parentElement.getBoundingClientRect();
            
        //     const threshold = 50; // Distance in pixels to detect the cursor near the button
        //     const minMoveDistance = 5; // Minimum distance to move the button
        //     const maxMoveDistance = 15; // Maximum distance to move the button

        //     if (Math.abs(event.clientX - buttonRect.left) < threshold || Math.abs(event.clientX - buttonRect.right) < threshold ||
        //         Math.abs(event.clientY - buttonRect.top) < threshold || Math.abs(event.clientY - buttonRect.bottom) < threshold) {

        //         let newLeft = buttonRect.left + (Math.random() > 0.5 ? 1 : -1) * (Math.random() * (maxMoveDistance - minMoveDistance) + minMoveDistance);
        //         let newTop = buttonRect.top + (Math.random() > 0.5 ? 1 : -1) * (Math.random() * (maxMoveDistance - minMoveDistance) + minMoveDistance);

        //         // Ensure the button stays within the container bounds
        //         newLeft = Math.max(containerRect.left, Math.min(newLeft, containerRect.right - buttonRect.width));
        //         newTop = Math.max(containerRect.top, Math.min(newTop, containerRect.bottom - buttonRect.height));

        //         button.style.position = "absolute";
        //         button.style.left = `${newLeft - containerRect.left}px`;
        //         button.style.top = `${newTop - containerRect.top}px`;
        //     }
        // });

        document.addEventListener('DOMContentLoaded', (event) => {
            const rejectButton = document.getElementById('rejectButton');
            const originalLeft = rejectButton.offsetLeft;
            const originalTop = rejectButton.offsetTop;
            const moveRange = 180; // Maximum distance the button can move
            const minMove = 80; // Minimum distance the button must move

            function getNewPosition(original, minMove, maxMove) {
                let newPos;
                do {
                    newPos = original + Math.random() * maxMove - maxMove / 2;
                } while (Math.abs(newPos - original) < minMove);
                return newPos;
            }

            rejectButton.addEventListener('mouseover', () => {
                const newX = getNewPosition(originalLeft, minMove, moveRange);
                const newY = getNewPosition(originalTop, minMove, moveRange);

                rejectButton.style.position = 'absolute';
                rejectButton.style.left = `${newX}px`;
                rejectButton.style.top = `${newY}px`;
            });
        });

        function refreshPage() {
            location.reload();
        }

        function displayRandomGif() {
            const randomIndex = Math.floor(Math.random() * invite_gif.length);
            const randomGif = invite_gif[randomIndex];
            document.getElementById("gifImage").src = randomGif;
        }

        window.addEventListener("load", () => {
            displayRandomGif();
            const username = "<%= username %>";
            if (!username) {
                const modal = document.getElementById('authentication-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        });
    </script>
<%- include('templates/html_end'); %>
